<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Miguel MZ - Research</title>
    <link rel="shortcut icon" href="../images/icon.png">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/bootstrap4-neon-glow.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel='stylesheet' href='//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body>

 <div class="navbar-dark text-white">
    <div class="container">
      <nav class="navbar px-0 navbar-expand-lg navbar-dark">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a href="../index.html" class="pl-md-0 p-3 text-light" style="font-family:courier,arial,helvética"># Start</a>
            <a href="../whoami.html" class="p-3 text-decoration-none text-light" style="font-family:courier,arial,helvética"># Whoami</a>
            <a href="../TEB_PEB.html" class="p-3 text-decoration-none text-light" style="font-family:courier,arial,helvética"> # TeB/PeB</a>
          </div>
        </div>
      </nav>
    </div>
  </div>

<div class="jumbotron bg-transparent mb-0 radius-0">
  <div class="container">
      <div class="row">
        <div class="">
          <h1 class="display-1" style="font-family:courier,arial,helvética">kd❯ <span class="vim-caret" style="font-family:courier,arial,helvética">g</span></h1>
          <div class="lead mb-3 text-mono text-success" style="font-size: 25px;font-family:courier,arial,helvética">fffff803'00000000 EB FE jmp short loc_HackinG</div>
          <p class="mt-5 text-grey text-spacey">
            <h1 style="font-family:courier,arial,helvética">~ ./priv</h1><br><br>
            <table border="0" width="100%">
                <tr>
                  <td style="font-size: 30px; color: aliceblue;font-family:courier,arial,helvética;">
                    Introduction to Binary Analysis on Embedded Devices
                  </td>
                </tr>
                <tr>
                  <td>
                    <hr>
                  </td>
                </tr>
                <tr>
                  <td align="justify" style="font-size: 20px; color: aliceblue;font-family:courier,arial,helvética;">
                    <p>
                      <font size="6"><b>[Introduction]</b></font><br><br>
                      In this publication on the Analysis of Binaries in Embedded Systems, some tools and methodologies used to carry out a practice of this type will be shown. In this case, the target embedded system corresponding to the D-LINK brand, where with a simple methodology, we will look for vulnerabilities that can be exploited both remotely and internally. The objective of the publication will be to show the environment for static and dynamic analysis of binaries, using dedicated systems such as AttifyOS.<br><br>

                      
                      The first step or starting point will be the download of the firmware to analyze <a href="https://support.dlink.com/ProductInfo.aspx?m=DIR-640L"><b style="color: mediumvioletred;">https://support.dlink.com/ProductInfo.aspx?m=DIR-640L</b></a> and as an addition, we leave the reader two options to set up the analysis environment depending on your level of tolerance and patience.<br><br>

                      <b style="color: #00e1d7;">Option 1:</b>
                      The simplest way and to avoid compatibility errors with the host system and its binaries, there is the operating system called AttifyOS (<a href="https://www.attify.com/attifyos"><b style="color: mediumvioletred;">https://www.attify.com/attifyos</b></a>), where it already contains an extensive list of tools for the analysis of IOT / Embedded systems.<br><br>

                      <b style="color: #00e1d7;">Option 2:</b>
                      This option is for those who want to have a hard time and gauge their own level of tolerance and patience. I personally recommend it when it is necessary to fully understand the whole process, doing “real hacking” and installing everything separately.<br><br>

                      <b style="color: #00e1d7;">[For now to avoid frying some brains, we will continue with the first option]</b><br><br>

                      <font size="6"><b>[Device]</b></font><br><br>
                      The DIR-640L Wireless N300 SOHO VPN Router device is a bit old, but for this post it is more than enough old but still contains crashes!.<br><br>

                      <center><img src="../images/intro_binary_emb/DIR-640L_A1_.jpg" width="50%" style="border-radius: 10px;"></center><br><br>
                      
                      Some patches applied in this version (<b style="color: mediumvioletred;">DIR-640LAx_FW102b02</b>) <a href="http://legacyfiles.us.dlink.com/DIR-640L/REVA/DIR-640L_REVA_FIRMWARE_1.02B02.ZIP"><b style="color: #a69c0d;">Download Firmaware Here</b></a><br><br>

                      * Fixed device cannot allow clients to access Internet through PPTP/L2TP connection issue. (DGC20130524000005)<br>
                      * Fixed WPS issue. (DRU20130807000002)<br>
                      * Fixed IPSec NAT-T issue (DRU20130705000002)<br>
                      * Fixed manual PPTP/L2TP remote IP range subnet checking issue<br>
                      * Fixed IxChariot cannot test when using Tx with Rx multi-pairs at same time<br>
                      * Fixed stress testing low session issue<br><br>

                      <font size="6"><b>[Decompile]</b></font><br><br>
                      Once the firmware is obtained, the first thing we must do is find a way to extract all the contents of the <b style="color: mediumvioletred;">DIR-640LAx_FW102b02.bin</b> file. We will achieve this using the Binwalk tool, which will help us extract images, binaries, file systems, etc.<br><br>

                      <table border="1" width="100%" style="background-color: darkgreen">
                        <tr>
                          <td>
                            <font style="color: #74ff00;">
                              $ binwalk -eM DIR-640LAx_FW102b02.bin
                            </font>
                          </td>
                        </tr>
                      </table>

                      <br><br><center><img src="../images/intro_binary_emb/IMG1.png" width="70%" style="border-radius: 10px;"></center><br><br>

                      Looking in the extracted directories (squashfs-root-0), we found three interesting <b style="color: mediumvioletred;">mdb</b>, <b style="color: mediumvioletred;">mydlink_signin_add</b> and <b style="color: mediumvioletred;">mydlink_signup_add</b>. Maybe these binaries don't have vulnerabilities that can be exploited remotely but, as mentioned at the beginning of the post. The goal is analysis. In any case, the existence of security problems is not ruled out.<br><br>

                      <center><img src="../images/intro_binary_emb/IMG2.png" width="50%" style="border-radius: 10px;"></center><br><br>

                      We get a bit of information from the binaries with the command <b style="color: mediumvioletred;">file</b>.<br><br>

                      <table border="1" width="100%" style="background-color: darkgreen">
                        <tr>
                          <td>
                            <font style="color: #74ff00;">
                              $ file mdb<br>
                              $ file mydlink_signup_add<br>
                              $ file mydlink_signin_add<br>
                            </font>
                          </td>
                        </tr>
                      </table><br><br>

                      1. 32-Bit ELF Binaries<br>
                      2. MIPS architecture, MIPS-II<br>
                      3. Interpreter /lib/ld-uClibc.so (we must load this library for further analysis) 

                      <br><br><center><img src="../images/intro_binary_emb/IMG3.png" width="85%" style="border-radius: 10px;"></center><br><br>

                      With this previous information, we have already moved on to the static analysis using IDA and Ghidra. These tools can be installed separately where it is the most comfortable for the investigator. This time the environment consists of a Windows 7/10 with IDA and Ghidra software on MacOS for convenience.<br><br>

                      With that said, we move on to loading the <b style="color: mediumvioletred;">mydlink_signin_add</b> binary in the debuggers. When the loading process finishes, we make some improvements to the code, such as renaming the main() function with its necessary arguments, fixing .text/.data/.rodata sections, assigning the correct data type to the variables and so on. Same new name to the variables used. Carrying out these small adjustments will help us to better understand when analyzing the code of the binary in question.<br><br>

                      <center><img src="../images/intro_binary_emb/IMG4.png" width="90%" style="border-radius: 10px;"></center><br><br>

                      After investing a good time in the small adjustments mentioned above, the first way to get valuable information about the code to be analyzed is to identify functions that are considered dangerous, where a small error in their implementation can leave the device vulnerable. To do this we, execute a custom script and in this way we will have an overview of where our possible starting points for the analysis of the binary..<br><br>

                      The result of the identification shows a series of potentially dangerous functions marked with a red dot, if some of these functions digest information manipulated by the user, it could be facing a potential vulnerability of the device. This requires tracing the path of the information received by the function itself and identifying at which point (if it exists) code can be injected to use the function differently (the net definition of to Hack, or to hack).

                      <br><br><center><img src="../images/intro_binary_emb/IMG5.png" width="90%" style="border-radius: 10px;"></center><br><br>

                      The above about dangerous functions will remain for the reader as a good example of good practice for analyzing binaries.<br><br>

                      Working on the static analysis of the main() function, the following piece of code was identified that contains an error in the logic that will later trigger the jackpot vulnerability. Before you can explain what is happening here, can you identify the fault?<br><br>

                      Before explaining the code and the vulnerability, it is necessary to understand how the copy of the data is in memory. In itself, the user string is copied to a calculated address, this calculation is two byte lower than the original data.<br><br>

                      <center><img src="../images/intro_binary_emb/IMG7.png" width="50%" style="border-radius: 10px;"></center><br><br>

                      <font size="6"><b>[Static Analysis]</b></font>

                      <br><br><center><img src="../images/intro_binary_emb/IMGCODE.png" width="60%" style="border-radius: 10px;"></center><br><br>

                      If you've already identified the vulnerability, congratulations! 🍻🎉🍻<br><br>

                      For those who cannot see the vulnerable pattern yet, we will analyze in detail and explain each part of the code until we find the vulnerability, and then we will go into dynamic analysis mode to verify our theory.<br><br>

                      <center><img src="../images/intro_binary_emb/IMGCODE1.png" width="44%" style="border-radius: 10px;"></center><br><br>

                      Line <b style="color: #00e1d7;">(1)</b> variable that stores the url read from the configuration file, the assigned size is nine positions or nine bytes, since a variable of type char each position occupies one byte in memory. (more information <a href="https://www.geeksforgeeks.org/data-types-in-c/"><b style="color: mediumvioletred;">https://www.geeksforgeeks.org/data-types-in-c/</b></a>). Line <b style="color: #00e1d7;">(2)</b> Pointer used as Buffer that will be used to store the username value and Line <b style="color: #00e1d7;">(3)</b> Opens the <b style="color: mediumvioletred;">provision.conf</b> file in the temporary directory in read mode.<br><br>

                      <center><img src="../images/intro_binary_emb/IMGCODE2.png" width="59%" style="border-radius: 10px;"></center><br><br>

                      In line <b style="color: #00e1d7;">(4)</b> the <b style="color: mediumvioletred;">url</b> buffer saves the information read from the "provision.conf" file and checks if it is different from NULL, then in <b style="color: #00e1d7;">(5)</b> it validates if the string <b style="color: mediumvioletred;">username=</b> exists in the <b style="color: mediumvioletred;">url</b> buffer, <b style="color: #00e1d7;">(6)</b> and <b style="color: #00e1d7;">(7)</b> validates that the username variable has a value.<br><br>

                      Now from line <b style="color: #00e1d7;">(8)</b> to <b style="color: #00e1d7;">(9)</b> there is a loop, which goes through the user string and then copying byte by byte in <b style="color: mediumvioletred;">buf80_username</b> and using <b style="color: mediumvioletred;">i2</b> as an incrementing index and in turn validating that the user string contains the characters from <b style="color: mediumvioletred;">;</b> or <b style="color: mediumvioletred;">null</b> to exit the copy stream. Lastly, add a string term <b style="color: mediumvioletred;">\0</b> to user.<br><br>

                      The problem is found in line <b style="color: #00e1d7;">(13)</b>, where the index <b style="color: mediumvioletred;">i1</b> that is used to traverse the user chain in line <b style="color: #00e1d7;">(14)</b> is incremented again. Here it should take as a value a <b style="color: mediumvioletred;">\0</b> of the user's string term and thus exit the loop <b style="color: #00e1d7;">(16)</b>.<br><br>

                      Now what would happen if we send a username with a length of 0x46 bytes?<br><br>

                      What would happen is that when sending 0x46 bytes it would step on a <b style="color: mediumvioletred;">\0</b> and when it is increased again <b style="color: #00e1d7;">(13)</b> it no longer takes the value <b style="color: mediumvioletred;">\0</b> to exit the cycle, but takes the value of the data sent which is <b style="color: mediumvioletred;">A's</b>, and for this reason the cycle remains infinite until all the memory of the stack is corrupted.<br><br>

                      Now what would happen if we send a username with a length of 0x46 bytes?<br><br>

                      What would happen is that when sending 0x46 bytes it would step on a <b style="color: mediumvioletred;">\0</b> and when it is increased again <b style="color: #00e1d7;">(13)</b> it no longer takes the value <b style="color: mediumvioletred;">\0</b> to exit the cycle, but takes the value of the data sent that is <b style="color: mediumvioletred;">A's</b>, and for this reason the cycle remains infinite until all the memory of the stack is corrupted.<br><br>

                      <font size="6"><b>[Dynamic Analysis]</b></font><br><br>

                      Before we start with the dynamic analysis and check what was explained above, we need to configure a few simple things to be able to debug and that the binary runs without problems.<br><br>

                      As we already know that it contains MIPS architecture, we use the <b style="color: mediumvioletred;">qemu</b> emulator from AttifyOS to execute the binary. The result of the execution shows that it needs a library <b style="color: mediumvioletred;">/lib/ld-uClibc.so.0</b>. This is very common when such a binary is to be executed.

                      <br><br><center><img src="../images/intro_binary_emb/IMG8.png" width="55%" style="border-radius: 10px;"></center><br><br>

                      The next step is to load the necessary libraries and for this we have 2 options.<br><br>

                      1. Load the libraries in the root of the system<br>
                      2. Use chroot to call the libraries locally (recommended)<br><br>

                      The following bash script is to execute the binary and leave it in standby mode on port 1337 to be able to take the process remotely with IDA.<br><br>

                      <center><img src="../images/intro_binary_emb/IMGCODE3.png" width="47%" style="border-radius: 10px;"></center><br><br>

                      <center>
                        <table border="1" width="70%" style="/*! border-radius: 10px; */border: hidden;">
                          <tr>
                            <td align="center">
                               <b>Variable</b>
                            </td>
                            <td align="center">
                               <b>Description</b> 
                            </td>
                          </tr>
                          <tr><td>DEBUG_IP</td><td>localhost address</td></tr>
                          <tr><td>DEBUG_PORT</td><td>port listen 1337</td></tr>
                          <tr><td>FUNC</td><td>function to load</td></tr>
                          <tr><td>BIN</td><td>path and name of the binary</td></tr>
                          <tr><td>URL</td><td>web path</td></tr>
                        </table>
                      </center><br><br>

                      After executing the script, the process is waiting to be taken from the IDA debugger.<br><br>

                      <center><img src="../images/intro_binary_emb/IMG9.png" width="47%" style="border-radius: 10px;"></center><br><br>

                      The information printed from the IP and Port script is used to configure the <b style="color: mediumvioletred;">Remote GDB Debugger</b> option, where hostname is the IP of the machine that is executing the script, and the Port is the service that is listening. Then the next step is to run the debugging process in IDA with the green arrow or directly with the F9 key.<br><br>

                      <center><img src="../images/intro_binary_emb/IMG10.png" width="50%" style="border-radius: 10px;"></center>
                      <br><br><center><img src="../images/intro_binary_emb/IMG11.png" width="35%" style="border-radius: 10px;"></center><br><br>

                      With the above, it is now possible to start a dynamic analysis of the binary and to verify the vulnerability, looking at the memory in real-time. However, first it is necessary to create the <b style="color: mediumvioletred;">provision.conf</b> file inside the <b style="color: mediumvioletred;">./tmp/</b> directory of the binary with the necessary bytes.<br><br>

                      The file is generated with the following information; The username as a variable for the condition to be met and enter the validation with a value in bytes of size 0x46 or 0x70 in decimal to cause the error.<br><br>

                      <center><img src="../images/intro_binary_emb/IMG13.png" width="70%" style="border-radius: 10px;"></center><br><br>

                      <font size="6"><b>[Summary]</b></font><br><br>

                      To close the article on "Introduction to binary analysis in embedded devices" here is an image of the main() function that contains the routine with the vulnerability.

                      <br><br><center><img src="../images/intro_binary_emb/IMG14.png" width="53%" style="border-radius: 10px;"></center><br><br>

                      <font size="6"><b>Video</b></font><br><br>
                      <a href="https://www.youtube.com/watch?v=CUqnuR5xRas" style="color: #a69c0d" target="_blank">https://www.youtube.com/watch?v=CUqnuR5xRas</a>
                      <br><br>
                    </p>
                  </td>
                </tr>
            </table>
          </p>
        </div>
      </div>
  </div>
</div>
<!--<div class="container py-5">
  <h4>Thanks</h4>
    <a href="https://github.com/s1kr10s">https://github.com/s1kr10s</a></p>
  
</div>-->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  </body>
</html>
